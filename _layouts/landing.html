<!DOCTYPE html>
<!--[if IE]>
<meta http-equiv="X-UA-Compatible" content="IE=100" />
<style type="text/css">
/* IE CSS HERE */
<style>
<![endif]-->

<html id="top">

<head>

{% include head.html %}

</head>

<body>

		{% include navigation.html %}

		<article>

			<h1>{{ page.heading }}</h1>

			{% if page.private %}
			<h2 class="subheading">This article is currently a private draft.</h2>
			{% else if page.subheading %}
			<h2 class="subheading">{{ page.subheading }}</h2>
			{% endif %}

			<!-- <span class="littleline"></span> -->

			{{ content }}

		</article>

		{% include footer.html %}

</body>


<script language="javascript">

	var musicManager = function($){

		function displaySongWithDescriptionInElement(songWithNameArtistImageUrl, description, element){
			var $element = $(element);
			var song = songWithNameArtistImageUrl;
			var songString = "";
			if (song && song.name){
				songString = song.name;
				if (song.artist){
					songString += " by " + song.artist;
				}
				$element.find('a').attr('href',song.url);
				$element.find('.background').attr('src', song.image);
				$element.find('h3').text(songString);
				$element.find('p').text(description);
			} else {
				$(element).remove();
			}
		}

		function displayMostPlayedSongThisWeek(){
			$.get('https://ws.audioscrobbler.com/2.0/?method=user.gettoptracks&user=grahammacphee&period=1month&api_key=5f134f063744307ee6f126ac2c480fab&format=json', function(data){
				var mostPlayedSong = {};
				try {
					mostPlayedSong['name'] = data.toptracks.track[0].name;
				} catch (e){
					// No name
					mostPlayedSong['name'] = null;
				}
				try {
					mostPlayedSong['artist'] = data.toptracks.track[0].artist.name;
				} catch (e){
					// No artist
					mostPlayedSong['artist'] = null;
				}
				try {
					mostPlayedSong['image'] = data.toptracks.track[0].image[data.toptracks.track[0].image.length-1]['#text'];
				} catch (e){
					// No image
					mostPlayedSong['image'] = null;
				}
				try {
					mostPlayedSong['url'] = data.toptracks.track[0].url;
				} catch (e){
					// No name
					mostPlayedSong['url'] = null;
				}
				return displaySongWithDescriptionInElement(mostPlayedSong,'Most played this month',$('#music-container'));
			}).fail(function (){
				$('#music-container').remove();
			});
		}

		return {
			displayMostPlayedThisWeek : displayMostPlayedSongThisWeek,
		}

	}($)

	var locationManager = function($){

		var $locationContainer = $('#latestLocation');

		var randomString = "AIzaSyDQJOQNtvd0-mEKu-2veoiz3QMnLf01kis";
		var mapZoomLevel = "10";

		var locationDataText;
		var locationData = [];
		var eventLocationDataProcessed = new Event('locationDataProcessed');

		function init(callback){
			getDataFromTextFile("https://dl.dropboxusercontent.com/u/17016249/Data/location.txt");
			if (callback){
				document.addEventListener('locationDataProcessed', callback, false);
			}
		}

		function getParameterByName(name, url) {
		    if (!url) url = window.location.href;
		    name = name.replace(/[\[\]]/g, "\\$&");
		    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
		        results = regex.exec(url);
		    if (!results) return null;
		    if (!results[2]) return '';
		    return decodeURIComponent(results[2].replace(/\+/g, " "));
		}

	    function getDataFromTextFile(file){
	        var rawFile = new XMLHttpRequest();
	        rawFile.open("GET", file, true);
	        rawFile.onreadystatechange = function (){
	            if(rawFile.readyState === 4){
	                if(rawFile.status === 200 || rawFile.status == 0){
	                    locationDataText = rawFile.responseText;
						processLocationData();
	                }
	            }
	        }
	        rawFile.send(null);
	    }

		function processLocationData(){
			var locationDataTextSplit = locationDataText.split("/%/");
			locationDataTextSplit.pop();
			for (i=0;i<locationDataTextSplit.length;i++){
				locationData.push(JSON.parse(locationDataTextSplit[i]));
			}
			document.dispatchEvent(eventLocationDataProcessed);
		}

		function displayLatestTrip(description, element){
			try {
				var $element = $(element);
				var latestLocation = locationData[locationData.length-1];
				$element.find('a').attr('href',latestLocation.linkURL);
				$element.find('.background').attr('src', latestLocation.mapImageURL.replace('http://', 'https://').replace('zoom=16', 'zoom=9').replace('size=710x440','size=320x160')+'&key='+randomString);
				$element.find('h3').text(latestLocation.name);
				$element.find('p').text(description);
			} catch (e){
				$(element).remove();
			}
		}

		return {
			init : init,
			displayLatestTrip : displayLatestTrip,
		}

	}($);

	var titleVariation = 0;

    $(document).ready(function(){
    	initLoadingState();
    	attachEvents();
		setStyling();
    	animLoadingState();
    	navigateToHashCategory();
    	musicManager.displayMostPlayedThisWeek();
    	locationManager.init(function(){
			locationManager.displayLatestTrip('Recent trip',$('#trip-container'));
		});
	});

    function initLoadingState(){
    	$('.block, .posttabs, .footerimg').css('opacity','0');
	    $('body').css('overflow-y','hidden');
	    $('.loadimg').css('opacity','0');
    }

    function animLoadingState(){
    	setTimeout(function(){
    		$('.loadimg').css('opacity','0');
    		setTimeout(function(){
	    		$('.loadimg').css('opacity','0');
	    		setTimeout(function(){
		    		$('.block, .posttabs, .footerimg').css('opacity','1');
		    		$('body').css('overflow-y','scroll');
					setTimeout(function(){
						startLoopTitle();
					},3000);
		    	},400);
	    	},0);
    	},0);
    }

    function setStyling(){
    	$('.title').html('Graham Macphee');
    	$('a').each(function() {
		    if ($(this).find('img').length) {
		        $(this).css('border','none');
		    }
		});
    }

    function navigateToHashCategory(){
    	var hash = location.hash.slice(1,-1);
    	$('.posttab[data-tab="'+hash+'"]').click();
    }

    function attachEvents(){}

    function controlMenu(){
		$('.menubutton').toggleClass('close');
		if ($('.menubutton').hasClass('close')){ // open menu
			openMenu();
		} else { // close menu
			closeMenu();
		}
	}

	function openMenu(){
		$('.block').addClass('menuopen');
		$('.menu').removeClass('closed');
		$('html,body').css('overflow','hidden');
	}

	function closeMenu(){
		$('.block').removeClass('menuopen');
		$('.menu').addClass('closed');
		$('html,body').css('overflow','auto');
	}

    function startLoopTitle(){
    	backspaceThis("Macphee".length,"is a designer.",0);
    }

	function animLoopTitle(){
		setTimeout(function(){
			if (titleVariation == 0){
				$('.title').html('Graham is a designer.');
				setTimeout(function(){
					typeReplace("is a designer.","writes code.");
				},500);
			} else if (titleVariation == 1){
				setTimeout(function(){
					typeReplace("writes code.","writes articles.");
				},500);
			} else if (titleVariation == 2){
				setTimeout(function(){
					typeReplace("writes articles.","takes photos.");
				},500);
			} else if (titleVariation == 3){
				setTimeout(function(){
					typeReplace("takes photos.","is a feminist.");
				},500);
			} else if (titleVariation == 4){
				setTimeout(function(){
					typeReplace("is a feminist.","Macphee");
				},500);
			} else if (titleVariation == 5){
				setTimeout(function(){
					typeReplace("Macphee","is a designer.");
				},500);
			}
		},2400);
	}

	function typeReplace(oldString,newString){
		var stepTo = (titleVariation+1) % 6;
		backspaceThis(oldString.length,newString,stepTo);
	}

	function backspaceThis(i,string,variation){
		if (i > 0){
			$('.cursor').removeClass('blink');
			setTimeout(function(){
				$('.title').html($('.title').text().slice(0,-1));
				backspaceThis(i-1,string,variation);
			},40);
		} else {
			setTimeout(function(){
				$('.cursor').addClass('blink');
			},400);
			setTimeout(function(){
				typeThis(string,1,variation);
			},700);
		}
	}

	function typeThis(string,i,variation){
		if (i <= string.length){
			$('.cursor').removeClass('blink');
			setTimeout(function(){
				$('.title').html($('.title').text() + string.slice(i-1,i));
				typeThis(string,i+1,variation);
			},110);
		} else {
			setTimeout(function(){
				$('.cursor').addClass('blink');
			},400);
			titleVariation = variation;
			// animLoopTitle();
		}
	}

	$(function() {
      $('a[href*="#"]:not([href="#"])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
          if (target.length) {
            $('html,body').animate({
              scrollTop: (target.offset().top - 30)
		  	}, 400);
            return false;
          }
        }
      });
    });

</script>

</html>
