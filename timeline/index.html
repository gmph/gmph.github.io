<!DOCTYPE html>

<html id="top">
<head>

    <title>Timeline</title>
    <meta name="author" content="Graham Macphee" />
    <meta name="description" content="" />
    <meta name="keywords" content=""/>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes" />

    <!-- Facebook -->
    <meta property="og:url"                content="http://gmph.co/timeline/" />
    <meta property="og:type"               content="article" />
    <meta property="og:title"              content="Timeline" />
    <meta property="og:description"        content="" />

    <!-- Twitter -->
    <meta name="twitter:card"              content="summary">
    <meta name="twitter:site"              content="@gmph">
    <meta name="twitter:creator"           content="@gmph">
    <meta name="twitter:title"             content="Timeline">
    <meta name="twitter:description"       content="">
    <meta property="twitter:account_id"    content="87261538" /> <!-- @gmph -->

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

    <link href='http://fonts.googleapis.com/css?family=Libre+Baskerville:400' rel='stylesheet' type='text/css'>

    <link rel="apple-touch-icon" size="180x180" href="app-icon.png">
    <link rel="shortcut icon" size="192x192" href="icon.png">
    <meta name="theme-color" content="#f8f8f8">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <link href="/res/css/main.css" rel="stylesheet" type="text/css">

    <style type="text/css">

    /* CSS RESET */

    textarea, input {
        outline: none;
    }

    * {
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        -moz-tap-highlight-color: rgba(0, 0, 0, 0);
        -webkit-touch-callout: none;
        /*-webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;*/
    }

    :focus {
        outline-color: transparent;
        outline-style: none;
    }

    /* END CSS RESET */

    @font-face {
        font-family: 'Helvetica Neue';
        src: url('/res/font/hnl.ttf') format('truetype');
        font-weight: 300;
    }

    @font-face {
        font-family: 'Helvetica Neue';
        src: url('/res/font/hnn.ttf') format('truetype');
        font-weight: 400;
    }

    @font-face {
        font-family: 'Helvetica Neue';
        src: url('/res/font/hnm.ttf') format('truetype');
        font-weight: 500;
    }

    @font-face {
        font-family: 'Helvetica Neue';
        src: url('/res/font/hnb.ttf') format('truetype');
        font-weight: 700;
    }

    html, body, .timeline-container {
        background: #f8f8f8 !important;
        min-height: 100vh;
        overflow: hidden;
    }

    .block {
        width: 100%;
        z-index: none;
        transform: none;
        -webkit-transform:none;
        margin-left: auto;
        margin-right: auto;
        padding: 24px 0 0 0;
    }

    .popup {
        display: block;
        position: fixed;
        top: 55%;
        left: 50%;
        z-index: 20;
        transform: translate(-50%, -50%);
        -webkit-transform: translate(-50%, -50%);
        width: 90%;
        max-width: 640px;
        max-height: 90vh;
        margin: 0 -4px 0 0;
        padding: 40px;
        background-color: #fff;
        box-shadow: 0 1px 4px rgba(0,0,0,.1), 0 4px 24px rgba(0,0,0,.15);
        border-radius: 4px;
        vertical-align: top;
        opacity: 0;
        pointer-events: none;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .popup.visible {
        top: 50%;
        opacity: 1;
        pointer-events: all;
    }

    .popup h1 {
        margin-bottom: 16px !important;
    }

    .display-as-h1 {
        font-size: 24px;
        margin: 0 auto;
    }

    .scrollbar-custom::-webkit-scrollbar {
        width: 4px;
        height: 4px;
        padding: 2px;
        background: transparent;
    }

    .scrollbar-custom::-webkit-scrollbar-track {
        width: 4px;
        height: 4px;
        background: transparent;
    }

    .scrollbar-custom::-webkit-scrollbar-thumb {
        width: 4px;
        height: 4px;
        margin: 2px;
        background: rgba(0,0,0,.25);
    }

    .scrollbar-custom::-webkit-scrollbar-button {
        width: 0;
        height: 0;
        display: none;
    }

    .connection {
        display: block;
        position: relative;
        top:0;
        left:0;
    }

    .connection.visible:not(.not-yet-established) {
        margin:0 0 40px 0;
    }

    .connection .banner {
        display: block;
        position: fixed;
        top:-40px;
        left:0;
        z-index: 30;
        width:100%;
        height:40px;
        margin:0 auto;
        padding:12px;
        border: none;
        background: #E64444;
        font-family: "Helvetica Neue", Helvetica Neue, Helvetica, Arial, sans-serif;
        font-size: 16px;
        line-height: 16px;
        color:white;
        text-align: center;
    }

    .connection.visible:not(.not-yet-established) .banner {
        top:0;
    }

    .timeline-container {
        width: 100%;
        height: 100%;
        margin: 0 auto 0 auto;
        padding: 0;
    }

    .page-inactive-cover {
        content: "";
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 10;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0);
        pointer-events: none;

        transition:.1s all ease-in;
        -webkit-transition:.1s all ease-in;
        -moz-transition:.1s all ease-in;
        -o-transition:.1s all ease-in;
    }

    .child-page .page-inactive-cover {
        content: "";
        background: rgba(0,0,0,.4);
        pointer-events: all;
    }

    .timeline-container.child-page .events, .timeline-container.child-page .navigation-block {
        pointer-events: none !important
    }

    .timeline-container .event-child:not(.visible) {
        top: 55% !important;
        opacity: 0 !important;
        pointer-events: none !important;
    }

    .timeline-container .event {
        margin: 0 auto 80px auto;
    }

    .timeline-container .event.unpublished {
        opacity: 1;
    }

    .timeline-container .author {
        display: block;
        position: relative;
        top:0;
        left:0;
        max-width: 100%;
        height: 40px;
        margin: 20px 0 16px 0;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .timeline-container .author img {
        display: block;
        position: absolute;
        top:0;
        left:0;
        width: auto;
        height: 100%;
        margin:0;
        border-radius: 20px;
        transform: translateZ(0);
    }

    .timeline-container .author .name {
        display: inline-block;
        position: relative;
        width: auto;
        height: auto;
        max-width: -webkit-calc(100% - 24px);
        max-width: calc(100% - 24px);
        /*margin: 8px 0 8px 56px;*/
        margin: 8px 0;
        padding: 0;
        color: #666;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
    }

    .gmph-sign-in {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        z-index: 30;
        transform: translate(-50%, -50%);
        -webkit-transform: translate(-50%, -50%);
        max-width: 240px;
        margin: 0;
        pointer-events: all;
        cursor: pointer;
    }

    .gmph-sign-in.visible {
        display: block;
    }

    .timeline-container .user-block {
        display: block;
        position: relative;
        padding: 0;
    }

    .timeline-container .navigation-block {
        display: block;
        position: static;
        width: 100%;
        margin: 0;
        padding: 0;
        background-color: transparent;
        vertical-align: top;
        opacity: 0;
        pointer-events: none;
    }

    .timeline-container .navigation-block .navigation-title {
        position: fixed;
        top: 36px;
        left: 24px;
        font-size: 22px;
        line-height: 24px;
        margin: 0;
        padding: 0 0 0 48px;
        max-width: 256px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .timeline-container .navigation-block .timelines-open {
        position: fixed;
        top: 36px;
        left: 24px;
        z-index: 5;
        width: 24px;
        height: 24px;
        margin: 0;
        padding: 0;
        background-image: url(menu.png);
        background-size: 24px 24px;
        background-position: center;
        background-repeat: no-repeat;
        border-radius: 32px;
        overflow: hidden;
        cursor: pointer;
        opacity: 0.85;
    }

    .timeline-container .navigation-block .timelines-open:hover {
        opacity: 1;
    }

    .timeline-container .timeline-share-open {
        display: block;
        position: fixed;
        top: 24px;
        left: auto;
        bottom: auto;
        right: 24px;
        z-index: 5;
        width: 48px;
        height: 48px;
        background-color: #eee;
        background-image: url(invite.png);
        background-size: 24px 24px;
        background-position: 45% 50%;
        background-repeat: no-repeat;
        border-radius: 32px;
        cursor: pointer;
    }

    .timeline-container .timeline-share-open:hover {
        background-color: #ddd;
    }

    .user-anonymous .timeline-container .navigation-block .navigation-timeline {
        left: 48px;
        width: -webkit-calc(100% - 232px);
        width: calc(100% - 232px);
    }

    .user-anonymous .timeline-container .navigation-block .timelines-open, .user-anonymous .timeline-container .navigation-block .timeline-share-open, .user-anonymous .timeline-container .navigation-block .event-new-open {
        opacity: 0;
        pointer-events: none;
    }

    .timeline-container .navigation-block .user-sign-in-refresh {
        display: block;
        position: fixed;
        top: 24px;
        left: auto;
        bottom: auto;
        right: 24px;
        z-index: 5;
        width: 120px;
        height: 48px;
        padding: 16px 24px;
        font-family: "Helvetica Neue", HelveticaNeue, Helvetica, Arial, sans-serif;
        font-size: 16px;
        font-weight: 500;
        color: #fff;
        background-color: #8B67FF;
        border-radius: 32px;
        text-align: center;
        border: none;
        cursor: pointer;
        opacity: 0;
        pointer-events: none;
    }

    .user-anonymous .timeline-container .navigation-block .user-sign-in-refresh {
        opacity: 1;
        pointer-events: all;
    }

    .user-anonymous .timeline-container .user-sign-in-refresh:hover {
        background-color: #8360f2;
        box-shadow: 0 2px 6px rgba(0,0,0,.4);

    }

    .timeline-container .navigation-block .navigation-timeline {
        display: block;
        position: fixed;
        top: 24px;
        left: 304px;
        width: -webkit-calc(100% - 416px);
        width: calc(100% - 416px);
        height: 48px;
        margin: 0 auto 0 auto;
        background: #eee;
        border-radius: 24px;
        box-shadow: -24px 0 0 #eee, 24px 0 0 #eee;
        overflow: hidden;
        cursor: pointer;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .timeline-container .navigation-block .navigation-timeline::after {
        content: "Time travel";
        display: block;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        transform: -webkit-translate(-50%, -50%);
        font-family: "Helvetica Neue", HelveticaNeue, Helvetica, Arial, sans-serif;
        font-size: 18px;
        color: #888;
        opacity: 1;
        pointer-events: none;

        transition:.15s all ease-out;
        -webkit-transition:.15s all ease-out;
        -moz-transition:.15s all ease-out;
        -o-transition:.15s all ease-out;
    }

    .timeline-container .navigation-block .navigation-timeline:hover::after, .timeline-container .navigation-block .navigation-timeline.active::after {
        content: "Time travel";
        display: block;
        position: absolute;
        top: -50%;
        left: 50%;
        transform: translate(-50%, -50%);
        transform: -webkit-translate(-50%, -50%);
        font-family: "Helvetica Neue", HelveticaNeue, Helvetica, Arial, sans-serif;
        font-size: 18px;
        color: #888;
        opacity: 0;
        pointer-events: none;
    }

    .timeline-container .navigation-block .navigation-timeline .timeline-label {
        display: block;
        position: absolute;
        top: 150%;
        left: 50%;
        transform: translate(-50%, -50%);
        transform: -webkit-translate(-50%, -50%);
        width: auto;
        height: auto;
        margin: 0;
        padding: 0 8px;
        white-space: nowrap;
        font-family: "Helvetica Neue", HelveticaNeue, Helvetica, Arial, sans-serif;
        font-size: 18px;
        color: #222;
        pointer-events: none;
        opacity: 0;

        -webkit-transition: 0s, .1s opacity ease-in-out, .15s top ease-in-out;
        -moz-transition: 0s, .1s opacity ease-in-out, .15s top ease-in-out;
        -ms-transition: 0s, .1s opacity ease-in-out, .15s top ease-in-out;
        -o-transition: 0s, .1s opacity ease-in-out, .15s top ease-in-out;
        transition: 0s, .1s opacity ease-in-out, .15s top ease-in-out;
    }

    .timeline-container .navigation-block .navigation-timeline:hover .timeline-label, .timeline-container .navigation-block .navigation-timeline.active .timeline-label {
        top: 50%;
        opacity: 1;
    }

    .timeline-container .navigation-block .navigation-timeline .first-date, .timeline-container .navigation-block .navigation-timeline .last-date {
        display: block;
        position: absolute;
        top: 50%;
        left: 4px;
        bottom: auto;
        right: auto;
        transform: translate(0, -50%);
        transform: -webkit-translate(0, -50%);
        width: auto;
        height: auto;
        margin: 0;
        padding: 0;
        white-space: nowrap;
        font-family: "Helvetica Neue", HelveticaNeue, Helvetica, Arial, sans-serif;
        font-size: 16px;
        color: #aaa;
        pointer-events: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        opacity: 1;
    }

    .timeline-container .navigation-block .navigation-timeline:hover .first-date, .timeline-container .navigation-block .navigation-timeline:hover .last-date, .timeline-container .navigation-block .navigation-timeline.active .first-date, .timeline-container .navigation-block .navigation-timeline.active .last-date {
        opacity: 0.2;
    }

    .timeline-container .navigation-block .navigation-timeline .last-date {
        left: auto;
        right: 4px;
    }

    .timeline-container .event-new.visible, .timeline-container .navigation-block.visible {
        top: 50%;
        opacity: 1;
        pointer-events: all;
    }

    .timeline-container .event-new .event-new-title, .timeline-container .event-new .event-new-content, .timeline-container .event-new .event-new-date {
        min-height: 28px;
        padding-bottom: 10px;
        background: #fff;
        box-shadow: 0 1px 0 #eee;
    }

    .timeline-container .event-new .event-new-title {
        font-family: "Helvetica Neue", HelveticaNeue, Helvetica, Arial, sans-serif;
        font-size: 28px !important;
    }

    .timeline-container .event-new .event-new-content, .timeline-container .event-new .event-new-date {
        font-family: "Helvetica Neue", HelveticaNeue, Helvetica, Arial, sans-serif;
        font-size: 18px;
    }

    .timeline-container .event-new .event-new-title:focus, .timeline-container .event-new .event-new-content:focus, .timeline-container .event-new .event-new-date:focus {
        box-shadow: 0 2px 0 #8B67FF;
    }

    .timeline-container .event-new .event-new-date {
        margin: 32px 0;
    }

    .timeline-container .event-new .event-new-content {
        height: auto;
        min-height: 96px;
        max-height: -webkit-calc(90vh - 300px);
        max-height: calc(90vh - 300px);
        white-space: normal;
        overflow-x: hidden;
        overflow-y: auto;
    }

    .timeline-container .event-new .event-new-publish-container {
        margin: 0;
    }

    .timeline-container .event-new .author {
        display: inline-block;
        width: auto;
        margin: 48px 0 0 0;
    }

    .timeline-container .event-new-signout {
        display: inline-block;
        position: relative;
        width: auto;
        margin: 0 0 0 16px;
        padding: 0;
        color: #999;
    }

    .timeline-container .event-new-open {
        display: block;
        position: fixed;
        top: auto;
        left: auto;
        bottom: 24px;
        right: 24px;
        z-index: 5;
        width: 64px;
        height: 64px;
        background-color: #8B67FF;
        background-image: url(add.png);
        background-size: 36px 36px;
        background-position: center;
        background-repeat: no-repeat;
        border-radius: 32px;
        box-shadow: 0 2px 6px rgba(0,0,0,.4);
        cursor: pointer;
    }

    .timeline-container .event-new-open:hover {
        transform: scale(1.05);
        transform: -webkit-scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,.4);
        background-color: #8360f2;
    }

    .event-new-publish-container {
        display: block;
        position: relative;
    }

    .button, .button-light {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .button.side-button-left, .button.side-button-right {
        display: block;
        position: static;
        float: left;
        top: auto;
        left: 40px;
        bottom: -40px;
        right: auto;
        vertical-align: bottom;
        width: 45%;
        max-width: 136px;
        margin: 40px 0 0 0;
        padding: 10px 10px 12px 10px;
        background: #aaa !important;
    }

    .button.side-button-right {
        float: right;
        top: auto;
        left: auto;
        bottom: -40px;
        right: 40px;
        background: #8B67FF !important;
    }

    .button.side-button-left:hover {
        background: #999 !important;
    }

    .button.side-button-right:hover {
        background: #8360f2 !important;
    }

    [contenteditable="true"], [contentedatible=""] {
        display: block;
        position: relative;
        width: 100%;
        min-height: 1em;
        cursor: text;
        white-space: pre-wrap;
        font-family: "Helvetica Neue", HelveticaNeue, Helvetica, Arial, sans-serif;
        font-size: 18px;
        box-shadow: 0 1px 0 #eee;
        margin: 0 auto 8px auto !important;
        padding: 24px 0 8px 0 !important;
    }

    [contenteditable="true"]:first-child, [contentedatible=""]:first-child {
        margin: -8px auto 8px auto !important;
    }

    [contenteditable="true"]:last-of-type, [contentedatible=""]:last-of-type {
        margin: 0 auto !important;
    }

    [contenteditable="true"]:focus,[contentedatible=""]:focus {
        box-shadow: 0 2px 0 #8B67FF;
    }

    [contenteditable="true"]:before, [contentedatible=""]:before {
        content: attr(data-placeholder);
        display: block;
        position: absolute;
        top:0;
        left:0;
        opacity: 0.35;
        font-size: 12px;
        font-weight: 500;

        transition:.15s all ease-in-out;
        -webkit-transition:.15s all ease-in-out;
        -moz-transition:.15s all ease-in-out;
        -o-transition:.15s all ease-in-out;
    }

    [contenteditable="true"]:empty:before, [contentedatible=""]:empty:before {
        top: 24px;
        font-size: inherit;
        font-weight: inherit;
        opacity: 0.5;
    }

    .event .button {
        display: inline-block !important;
        width: auto !important;
        min-width: 0 !important;
        margin: 0 16px 0 -8px;
        padding: 8px;
        background: none !important;
        box-shadow: none !important;
        text-align: left;
    }

    .button-light {
        font-size: 14px;
        font-weight: 500;
        color: #888 !important;
        background: none !important;
        margin: 0 !important;
        padding: 6px 8px !important;
        border: none !important;
        border-radius: 4px !important;
        color: #8B67FF !important;
    }

    .button-light:hover {
        background: rgba(0,0,0,.05) !important;
    }

    .event .button-light {
        background: rgba(0,0,0,.04) !important;
    }

    .event .button-light:hover {
        background: rgba(0,0,0,.08) !important;
    }

    .button.disabled {
        opacity: 0.5 !important;
        pointer-events: none;
    }

    .button, a.button {
        border-bottom: none;
    }

    .button:not(.button-light):hover, a.button:not(.button-light):hover {
        background: #8360f2;
        border-bottom: none;
    }

    .cursor-pointer {
        cursor: pointer !important;
    }

    .timeline-container {
        display: block;
        position: absolute;
        top:0;
        left:0;
        width: 100%;
        height: auto;
        min-height: 100vh;
        margin: 0;
        overflow: hidden;
    }

    .events {
        display: block;
        position: static;
        top: 0;
        left:0;
        width: 100%;
        height: -webkit-calc(100vh - 88px);
        height: calc(100vh - 88px);
        margin: 88px 0 0 0;
        padding: 12px 12px 24px 12px;
        overflow-x: auto;
        overflow-y: hidden;
        white-space: nowrap;
        direction: rtl;
        text-align: left;
    }

    .events:empty::after {
        content:"Click the ‘+’ button to add an event to your timeline";
        display: inline-block;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%,-50%);
        -webkit-transform: translate(-50%,-50%);
        width: auto;
        max-width: 320px;
        font-family: "Helvetica Neue", HelveticaNeue, Helvetica, Arial, sans-serif;
        font-size: 24px;
        font-weight: 400;
        line-height: 1.4em;
        color: #aaa;
        text-align: center;
        direction: ltr;
        overflow: hidden;
        white-space: normal;
    }

    .events * {
        direction: ltr;
    }

    .events .event {
        display: inline-block;
        position: relative;
        top: 0;
        left: 0;
        width: 100%;
        max-width: 368px;
        max-height: 100%;
        vertical-align: top;
        margin: 0 12px;
        padding: 20px;
        box-shadow: 0 1px 4px rgba(0,0,0,.1);
        background-color: #fff;
        border-radius: 4px;
        text-align: left;
        overflow-y: auto;
        overflow-x: hidden;
        direction: ltr;
    }

    body:not(.user-anonymous) .events .event {
        cursor: pointer;
    }

    body:not(.user-anonymous) .events .event:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,.2);
    }

    .events .event * {
        direction: ltr;
        text-align: left;
        white-space: normal;
    }

    .events .event h1 {
        position: static;
        font-size: 20px;
        line-height: 1.5em;
    }

    .events .event img, .events .event a, .events .event h2, .events .event h3, .events .event h4, .events .event ul, .events .event ol, .events .event li {
        position: static;
    }

    .events .event p {
        position: static;
        margin-top: 8px;
    }

    .events .event a {
        opacity: 1;
    }

    .events .event p, .events .event ul, .events .event ol, .events .event blockquote, .events .event code {
        margin-top: 8px;
        font-size: 15px;
    }

    .events .event .author {
        margin: 8px 0;
    }

    .timeline-container .event-child {
        padding: 56px;
    }

    .timeline-container .event-child .event-content .event {
        margin-bottom: 40px;
    }

    .block {
        display: block;
        overflow: hidden;
    }

    .sign-in {
        z-index: 50;
    }

    .sign-in .display-as-h1 {
        font-size: 24px;
    }

    .sign-in .display-as-p {
        margin: 28px auto 0 auto !important;
        padding-bottom: 8px !important;
    }

    .sign-in .sign-in-password {
        -webkit-text-security: disc;
        -webkit-user-select: text;
    }

    .timelines.popup {
        top: 0;
        left: -400px;
        transform: none;
        -webkit-transform: none;
        height: 100vh;
        max-height: 100vh;
        width: 85vw;
        max-width: 400px;
        border-radius: 0;
        padding: 32px;
    }

    .timelines.popup.visible {
        top: 0;
        left: 0;
    }

    .timelines.popup h1 {
        padding: 2px 0 24px 40px;
        font-size: 22px;
        line-height: 24px;
    }

    .timeline-container .navigation-block .timelines-open {
        position: fixed;
        top: 36px;
        left: 24px;
        z-index: 5;
        width: 24px;
        height: 24px;
        margin: 0;
        padding: 0;
        background-image: url(menu.png);
        background-size: 24px 24px;
        background-position: center;
        background-repeat: no-repeat;
        border-radius: 32px;
        overflow: hidden;
        cursor: pointer;
        opacity: 0.85;
    }

    .timeline-container .navigation-block .timelines-open:hover {
        opacity: 1;
    }

    .timelines.popup .timelines-close {
        position: absolute;
        top: 35px;
        left: 28px;
        z-index: 35;
        width: 24px;
        height: 24px;
        margin: 0;
        padding: 0;
        background-image: url(back.png);
        background-size: 24px 24px;
        background-position: center;
        background-repeat: no-repeat;
        border-radius: 32px;
        overflow: hidden;
        cursor: pointer;
        opacity: 0.85;
    }

    .timelines.popup .timelines-close:hover {
        opacity: 1;
    }

    .timelines .timeline-list {
        margin: 0 auto;
    }

    .timelines .timeline {
        display: block;
        position: relative;
        top:0;
        left:0;
        width: -webkit-calc(100% + 36px);
        width: calc(100% + 36px);
        margin: 12px -18px;
        padding: 16px;
        background: rgba(0,0,0,0);
        border-radius: 4px;
        cursor: pointer;
    }

    .timelines .timeline:hover {
        background: rgba(0,0,0,.04);
    }

    .timelines .timeline .title {
        display: inline-block;
        width: auto;
        margin: 0 16px 0 0;
        font-family: "Helvetica Neue", HelveticaNeue, Helvetica, Arial, sans-serif;
        font-size: 18px;
        color: #333;
        vertical-align: middle;
    }

    .timelines .timeline:hover .title {
        color: #000;
    }

    .timelines .timeline.timeline-new-open .title {
        color: #8B67FF;
        font-weight: 500;
]    }

    .timelines .timeline.timeline-new-open:hover .title {
        color: #8360f2;
    }

    .timelines .timeline-list .timeline .date {
        display: inline-block;
        width: auto;
        margin: 0 16px 0 0;
        font-family: "Helvetica Neue", HelveticaNeue, Helvetica, Arial, sans-serif;
        font-size: 14px;
        color: #888;
        margin: 4px 0 0 0;
        padding: 0 0 2px 0;
        vertical-align: middle;
    }

    .timelines .timeline-list .timeline .timeline-delete {
        display: block;
        position: absolute;
        top: 50%;
        right: 12px;
        transform: translate(0, -50%);
        -webkit-transform: translate(0, -50%);
        font-family: "Helvetica Neue", HelveticaNeue, Helvetica, Arial, sans-serif;
        font-size: 16px;
    }

    .color-destructive {
        color: #E64444 !important;
    }

    [type="checkbox"]:not(:checked),
    [type="checkbox"]:checked {
        position: absolute;
        left: -9999px;
    }

    [type="checkbox"]:not(:checked) + label,
    [type="checkbox"]:checked + label {
        display: inline-block;
        position: relative;
        margin: 32px 0 0 0;
        padding: 8px 0 0 40px;
        font-family: "Helvetica Neue", HelveticaNeue, Helvetica, Arial, sans-serif;
        font-size: 18px;
        line-height: 24px;
        font-weight: 500;
        color: #333;
        cursor: pointer;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    [type="checkbox"]:not(:checked) + label:before,
    [type="checkbox"]:checked + label:before {
        content: "";
        position: absolute;
        top: 8px;
        left:0;
        width: 24px;
        height: 24px;
        background-color: #bbb;
        border-radius: 3px;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    [type="checkbox"]:not(:checked) + label:before:hover {
        background-color: #999;
    }

    [type="checkbox"]:checked + label:before {
        content: "";
        background-color: #8B67FF;
    }

    [type="checkbox"]:not(:checked) + label:after,
    [type="checkbox"]:checked + label:after {
        content: "";
        position: absolute;
        top: 8px;
        left: 0;
        width: 24px;
        height: 24px;
        background-image: url(tick.png);
        background-size: 24px;
        background-position: center;
        background-repeat: no-repeat;
        -webkit-transition: all .2s ease-in-out;
        -moz-transition: all .2s ease-in-out;
        -ms-transition: all .2s ease-in-out;
        -o-transition: all .2s ease-in-out;
        transition: all .2s ease-in-out;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    [type="checkbox"]:not(:checked) + label:after {
        opacity: 0;
    }

    [type="checkbox"]:checked + label:after {
        opacity: 1;
    }

    .timeline-share .timeline-share-url {
        display: block;
        position: relative;
        top: 0;
        left: 0;
        width: 100%;
        height: auto;
        margin: 16px auto 8px auto;
        padding: 16px;
        background: #eee;
        border-radius: 3px;
        overflow-y: hidden;
        overflow-x: auto;
        white-space: nowrap;
        font-family: "Helvetica Neue", HelveticaNeue, Helvetica, Arial, sans-serif;
        font-size: 16px;
        line-height: 16px;
        font-weight: 400;
        opacity: 0.3;
        pointer-events: none;
        cursor: pointer;
    }

    .timeline-share.visible .timeline-share-url.visible {
        opacity: 1;
        pointer-events: all;
    }

    .timeline-share .timeline-share-url:not(.visible) {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .timeline-share .timeline-share-url::after {
        content: "Copied";
        display: block;
        position: absolute;
        top: 0;
        right: 8px;
        width: 72px;
        height: auto;
        margin: 8px 0;
        padding: 8px 0;
        font-size: 16px;
        line-height: 16px;
        font-family: "Helvetica Neue", HelveticaNeue, Helvetica, Arial, sans-serif;
        text-align: center;
        color: #fff;
        background-color: #8B67FF;
        border-radius: 2px;
        opacity: 0;
        pointer-events: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;

        transition:.15s all ease-out;
        -webkit-transition:.15s all ease-out;
        -moz-transition:.15s all ease-out;
        -o-transition:.15s all ease-out;
    }

    .timeline-share .timeline-share-url.alert-copied::after {
        opacity: 1;
        pointer-events: all;
    }

    @media (max-width: 800px){

        .timeline-container .navigation-block .timelines-open, .timeline-container .navigation-block .navigation-title {
            top: 24px;
        }

        .user-anonymous .timeline-container .navigation-block .navigation-title {
            padding: 0;
        }

        .timeline-container .navigation-block .timeline-share-open {
            width: 24px;
            height: 24px;
            background-color: transparent !important;
            border-radius: 0;
            opacity: 0.85;
        }

        .timeline-container .navigation-block .timelines-open:hover {
            opacity: 1;
        }

        .timeline-container .event-new-open {
            bottom: 16px;
            right: 16px;
            width: 48px;
            height: 48px;
            background-size: 32px;
        }

        .timeline-container .navigation-block .navigation-timeline {
            top: auto;
            bottom: 16px;
            left: 40px;
            width: -webkit-calc(100% - 144px);
            width: calc(100% - 144px);
        }

        .user-anonymous .timeline-container .navigation-block .navigation-timeline {
            bottom: 16px;
            left: 40px;
            width: -webkit-calc(100% - 80px);
            width: calc(100% - 80px);
        }

        .timeline-container .navigation-block .navigation-timeline::after {
            content:"" !important;
        }

        .timelines.popup {
            padding-top: 24px;
        }

        .timelines.popup .timelines-close {
            top: 28px;
        }

        .timeline-container .navigation-block .user-sign-in-refresh {
            top: 16px;
            left: auto;
            bottom: auto;
            right: 16px;
            height: 40px;
            width: 104px;
            padding: 11px 16px 13px 16px;
        }

        .events {
            height: -webkit-calc(100vh - 60px);
            height: calc(100vh - 60px);
            margin: 60px 0 0 0;
            padding: 12px 8px 80px 8px;
        }

        .events .event {
            max-width: 312px;
            margin: 0 8px;
        }

    }

    @media (max-width: 352px){

        .timeline-container .navigation-block .navigation-timeline {
            display: none !important;
        }

        .events {
            padding: 12px 8px 16px 8px;
        }

    }

    </style>

</head>

<body>

    <div class="connection not-yet-established">
        <div class="banner">No connection. Changes may not be saved.</div>
    </div>

    <div class="block visible">
        <div class="timeline-container">
            <div class="page-inactive-cover"></div>
            <div class="event-child popup">
                <div class="event-content"></div>
                <div class="button back sans-serif" onclick="closeChildPage()">Close</div>
            </div>
            <div class="user-block">
                <div class="navigation-block">
                    <h1 class="navigation-title">Timeline</h1>
                    <div class="timelines-open"></div>
                    <div class="navigation-timeline">
                        <div class="first-date"></div>
                        <div class="last-date"></div>
                        <div class="timeline-label"></div>
                    </div>
                    <div class="timeline-share-open"></div>
                    <a class="user-sign-in-refresh">Sign in</a>
                    <div class="event-new-open"></div>
                </div>
            </div>
            <div class="event-new popup buttoned scrollbar-custom">
                <div class="event-new-title display-as-h1" data-placeholder="Title" contenteditable="true"></div>
                <div class="event-new-date display-as-p" data-placeholder="Date (e.g. May 1996)" contenteditable="true"></div>
                <div class="event-new-content display-as-p" data-placeholder="Description of the event (optional)" contenteditable="true"></div>
                <div class="event-new-close button side-button-left">Cancel</div>
                <div class="event-new-publish button side-button-right disabled">Save</div>
            </div>
            <div class="events scrollbar-custom"></div>
        </div>
    </div>

    <div class="sign-in popup buttoned scrollbar-custom">
        <h1 class="display-as-h1">Sign in</h1>
        <div class="sign-in-email display-as-p" data-placeholder="Email address" contenteditable="true" type="email"></div>
        <div class="sign-in-password display-as-p" data-placeholder="Password" contenteditable="true" type="password"></div>
        <div class="sign-in-submit side-button-right button">Sign in</div>
    </div>

    <div class="timelines popup buttoned scrollbar-custom">
        <div class="timelines-close"></div>
        <h1 class="display-as-h1">Timelines</h1>
        <div class="timeline-list"></div>
        <div class="timeline timeline-new-open">
            <div class="title">Create new</div>
        </div>
    </div>

    <div class="timeline-new popup buttoned scrollbar-custom">
        <h1 class="display-as-h1">Create a timeline</h1>
        <div class="timeline-new-name display-as-p" data-placeholder="Title (e.g. John Smith WW2)" contenteditable="true"></div>
        <div class="timeline-new-create side-button-right button">Create</div>
        <div class="timeline-new-close side-button-left button">Close</div>
    </div>

    <div class="timeline-share popup buttoned scrollbar-custom">
        <h1 class="display-as-h1">Share timeline</h1>
        <p class="display-as-p">Let your friends and family view this timeline by sharing a link with them. Only you can edit your timelines.</p>
        <input type="checkbox" id="timeline-share-checkbox" />
        <label for="timeline-share-checkbox">Enable sharing</label>
        <div class="timeline-share-url scrollbar-custom">http://gmph.co/timeline#tQgdoj_us-2I82hXJdZK-</div>
        <div class="timeline-share-close side-button-left button">Close</div>
    </div>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.6/marked.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/3.4.1/firebase.js"></script>
    <script type="text/javascript" src="chrono.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.js"></script>

    <script language="javascript">

    var rootRef;
    var userRef;
    var timelineRef;
    var eventsRef;
    var connectedRef;

    var manualDateSet = false;
    var isChildPage = false;

    var userData = null;
    var timelineData = null;
    var eventsData = null;
    var eventDates = [];

    var chron = new chrono.Chrono();

    document.onclick = function () {};

    $(document).ready(function(){
        init();
    });

    function init(){
        // Firebase
        var config = {
            apiKey: "AIzaSyDyGLTluIS4SwTQefYdFXjczodfnSZSAJA",
            authDomain: "gmphtimeline.firebaseapp.com",
            databaseURL: "https://gmphtimeline.firebaseio.com",
            storageBucket: "gmphtimeline.appspot.com",
            messagingSenderId: "854285682295"
        };

        firebase.initializeApp(config);
        rootRef = firebase.database().ref('/');
        connectedRef = rootRef.child(".info/connected");
        connectedRef.on('value', onConnectionChanged, warnError);
        manageAuth();
        attachEvents();
    }

    function closeNewEvent(didPost){
        window.location.hash = "";
        manualDateSet = false;
        if (didPost === true) {
            var originaltext = $('.event-new-publish').text();
            $('.event-new-publish').addClass('disabled').text('Done!');
            setTimeout(function(){
                $('.event-new-publish').text(originaltext);
            },2000);
        }
        $('.timeline-container').removeClass('child-page')
        $('.event-new-title, .event-new-content, .event-new-date').text('');
        $('.event-new').attr('data-id','').removeClass('visible');
        blurAllFields();
    };

    function manageAuth(){
        firebase.auth().onAuthStateChanged(function (user) {
            setSignInOrUserState();
        });
    }

    function setNoConnectionBarVisible(shouldSetAsVisible){
        if (shouldSetAsVisible){
            $('.connection').removeClass('visible').removeClass('not-yet-established');
        } else {
            $('.connection').addClass('visible');
        }
    }

    function getUser(){
        getUserFromLoginDetails();
    }

    function setUpChrono(){

        var wholeMonthRefiner = new chrono.Refiner();
        wholeMonthRefiner.refine = function(text, results, opt){
            return results.map(function(r){
                if (!isOnlyCertainMonth(r.start) && r.end && !isOnlyCertainMonth(r.end)) return r

                if (!r.end) r.end = r.start.clone()

                r.start.imply('day', 1)
                r.start.imply('hour', 0)
                r.start.imply('minute', 0)
                r.start.imply('second', 0)
                r.start.imply('millisecond', 0)

                var momentEnd = moment(r.end.date()).endOf('month')
                r.end.assign('month', momentEnd.get('month') + 1)
                r.end.imply('day', momentEnd.get('date'))
                r.end.imply('hour', momentEnd.get('hour'))
                r.end.imply('minute', momentEnd.get('minute'))
                r.end.imply('second', momentEnd.get('second'))
                r.end.imply('millisecond', momentEnd.get('millisecond'))

                return r
            });
        }

        var gbDatesRefiner = new chrono.Refiner();
        gbDatesRefiner.refine = function(text, results, opt){
            return results.map(function(r){
                if (r.start.isCertain('month') && r.start.isCertain('day') && r.start.get('day') <= 12) {
                    var month = r.start.get('month');
                    var day = r.start.get('day');
                    r.start.assign('month', day);
                    r.start.assign('day', month);
                }
                return r;
            });
        }

        chron.refiners.push(wholeMonthRefiner);
        // chron.refiners.push(gbDatesRefiner);

    }

    function isOnlyCertainMonth (date) {
        return date.isCertain('month')
        && !date.isCertain('day')
        && !date.isCertain('hour')
        && !date.isCertain('minute')
        && !date.isCertain('second')
        && !date.isCertain('millisecond')
    }

    function attachEvents(){

        var clickEventString = 'click';
        var onlyAuthenticatedUserString = 'body:not(.user-anonymous) ';

        $(document).off(clickEventString, '.page-inactive-cover');
        $(document).on(clickEventString, '.page-inactive-cover', function(e){
            e.stopPropagation();
            closeTimelines();
            closeNewTimeline();
            closeShareTimeline();
        });

        $(document).off('mouseenter', '.navigation-timeline');
        $(document).off('mouseleave', '.navigation-timeline');
        $(document).on('mouseenter', '.navigation-timeline', function(){
            $(document).on('mousemove', '.navigation-timeline', handleTimeTravel);
        }).on('mouseleave', function(){
            $(document).off('mousemove', '.navigation-timeline');
        });

        $(document).off('touchstart', '.navigation-timeline');
        $(document).off('touchend', '.navigation-timeline');
        $(document).on('touchstart', '.navigation-timeline', function(){
            $(document).on('touchmove', '.navigation-timeline', handleTimeTravel);
            $(this).addClass('active');
        }).on('touchend', '.navigation-timeline', function(e){
            $(document).off('touchmove', '.navigation-timeline');
            e.stopPropagation();
            onNavigationTimelineClick(this);
        });

        $(document).off(clickEventString, '.navigation-timeline');
        $(document).on(clickEventString, '.navigation-timeline', function(e){
            e.preventDefault();
            onNavigationTimelineClick(this);
        });

        $(document).off('keyup', onlyAuthenticatedUserString + '.event-new-title, .event-new-content, .event-new-date');
        $(document).on('keyup', onlyAuthenticatedUserString + '.event-new-title, .event-new-content, .event-new-date', function () {
            if ($(this).text().replace(/\s*/g,'').length == 0) {
                $(this).empty();
            } else if ($(this).hasClass('event-new-date')){
                manualDateSet = true;
            }
            updatePublishButtonState();
            updateDatePrediction();
        });

        $(document).off(clickEventString, '.events .event a, .events .event .button, .events .event .button-light');
        $(document).on(clickEventString, '.events .event a, .events .event .button, .events .event .button-light', function(e){
            e.stopPropagation();
        });

        $(document).off(clickEventString, '.events .event img:not(a img)');
        $(document).on(clickEventString, '.events .event img:not(a img)', function(e){
            e.stopPropagation();
            openImageSourceInNewTab(this)
        });

        openImageSourceInNewTab

        $(document).off(clickEventString, onlyAuthenticatedUserString + '.event-new-open');
        $(document).on(clickEventString, onlyAuthenticatedUserString + '.event-new-open', function(e){
            e.stopPropagation();
            openNewEvent();
        });

        $(document).off(clickEventString, onlyAuthenticatedUserString + '.event-new-close');
        $(document).on(clickEventString, onlyAuthenticatedUserString + '.event-new-close', function(e){
            e.stopPropagation();
            closeNewEvent();
        });

        $(document).off(clickEventString, onlyAuthenticatedUserString + '.event-new-publish');
        $(document).on(clickEventString, onlyAuthenticatedUserString + '.event-new-publish', function(e){
            e.stopPropagation();
            createOrUpdateEvent();
        });

        $(document).off(clickEventString, onlyAuthenticatedUserString + '.timelines-open');
        $(document).on(clickEventString, onlyAuthenticatedUserString + '.timelines-open', function(e){
            e.stopPropagation();
            openTimelines();
        });

        $(document).off(clickEventString, onlyAuthenticatedUserString + '.timelines-close');
        $(document).on(clickEventString, onlyAuthenticatedUserString + '.timelines-close', function(e){
            e.stopPropagation();
            closeTimelines();
        });

        $(document).off(clickEventString, onlyAuthenticatedUserString + '.timelines .timeline-list .timeline');
        $(document).on(clickEventString, onlyAuthenticatedUserString + '.timelines .timeline-list .timeline', function(e){
            e.stopPropagation();
            closeTimelines();
            openTimeline($(this).attr('data-id'));
        });

        $(document).off(clickEventString, onlyAuthenticatedUserString + '.timelines .timeline-new-open');
        $(document).on(clickEventString, onlyAuthenticatedUserString + '.timelines .timeline-new-open', function(e){
            e.stopPropagation();
            closeTimelines();
            openNewTimeline();
        });

        $(document).off(clickEventString, onlyAuthenticatedUserString + '.timeline-new .timeline-new-close');
        $(document).on(clickEventString, onlyAuthenticatedUserString + '.timeline-new .timeline-new-close', function(e){
            e.stopPropagation();
            closeNewTimeline();
        });

        $(document).off(clickEventString, onlyAuthenticatedUserString + '.timeline-new .timeline-new-create');
        $(document).on(clickEventString, onlyAuthenticatedUserString + '.timeline-new .timeline-new-create', function(e){
            e.stopPropagation();
            var name = $(this).parent().find('.timeline-new-name').text();
            createTimeline(name, function(id){
                openTimeline(id);
                closeTimelines();
            });
        });

        $(document).off(clickEventString, onlyAuthenticatedUserString + '.timeline-list .timeline .timeline-delete');
        $(document).on(clickEventString, onlyAuthenticatedUserString + '.timeline-list .timeline .timeline-delete', function(e){
            e.stopPropagation();
            var timelineId = $(this).parent().attr('data-id');
            archiveTimeline(timelineId, function(){
                if (timelineId == timelineRef.key){
                    openTimeline();
                }
            });
        });

        $(document).off(clickEventString, onlyAuthenticatedUserString + '.timeline-share-open');
        $(document).on(clickEventString, onlyAuthenticatedUserString + '.timeline-share-open', function(e){
            e.stopPropagation();
            openShareTimeline();
        });

        $(document).off(clickEventString, onlyAuthenticatedUserString + '.timeline-share-close');
        $(document).on(clickEventString, onlyAuthenticatedUserString + '.timeline-share-close', function(e){
            e.stopPropagation();
            closeShareTimeline();
        });

        $(document).off('change', onlyAuthenticatedUserString + '#timeline-share-checkbox');
        $(document).on('change', onlyAuthenticatedUserString + '#timeline-share-checkbox', function(e){
            e.stopPropagation();
            toggleTimelineSharing();
        });

        $(document).off('click', '.timeline-share-url');
        $(document).on('click', '.timeline-share-url', function(e){
            e.stopPropagation();
            copyElementTextToClipboard($(this));
        });

        $(document).off('blur', onlyAuthenticatedUserString + '.event-new-date');
        $(document).on('blur', onlyAuthenticatedUserString + '.event-new-date', function () {
            var datePrediction = getTimeTextFromString(parseDateTimestamp($(this).text()), true);
            if (datePrediction) $(this).text(datePrediction);
        });

        $(document).off('paste', '[contenteditable]');
        $(document).on('paste', '[contenteditable]', function(e) {
            e.preventDefault();
            var text = e.originalEvent.clipboardData.getData("text/plain");
            document.execCommand("insertHTML", false, text);
        });

        $(document).off(clickEventString,'.back');
        $(document).on(clickEventString,'.back', function(e){
            if (isChildPage){
                e.stopPropagation();
                e.preventDefault();
                closeChildPage();
            }
        });

        $(document).off(clickEventString, onlyAuthenticatedUserString + '.events .event:not(.unpublished)');
        $(document).on(clickEventString, onlyAuthenticatedUserString + '.events .event:not(.unpublished)', function(e){
            e.stopPropagation();
            getEventByID($(this).attr('data-id'), openNewEvent);
        });

        $(document).off(clickEventString, '.gmph-sign-in');
        $(document).on(clickEventString, '.gmph-sign-in', function(e){
            e.stopPropagation();
            getUser();
        });

        $(document).off(clickEventString, '.sign-in .sign-in-submit');
        $(document).on(clickEventString, '.sign-in .sign-in-submit', function(e){
            e.stopPropagation();
            var $form = $(this).closest('.sign-in');
            var email = $form.find('.sign-in-email').text()
            var password = $form.find('.sign-in-password').text();
            signInOrCreateUserWithEmailAndPassword(email, password);
        });

        $(document).off(clickEventString, '.user-sign-in-refresh');
        $(document).on(clickEventString, '.user-sign-in-refresh', function(e){
            e.stopPropagation();
            openRootUrl();
        });

    }

    function onNavigationTimelineClick(element){
        var eventId = $(element).find('.timeline-label').attr('data-id');
        $('.events .event').scrollTop(0);
        if (eventId != null && eventId != undefined && eventId != ""){
            $('.events').animate({
                scrollLeft: $('.events').get(0).scrollWidth * parseFloat($('.navigation-timeline .timeline-label').attr('data-perc')) - 64,
            });
            highlightEventForXSeconds(eventId,1);
        }
    }

    function handleTimeTravel(e){
        var elm = $(e.target);
        if (eventDates.length){
            var xPos = (e.pageX || e.originalEvent.touches[0].pageX || e.originalEvent.changedTouches[0].pageX) - elm.offset().left;
            var width = elm.outerWidth();
            var xPerc = xPos / width;
            var earliestDate = eventDates[0] - 200;
            var latestDate = eventDates[eventDates.length - 1] + 200;
            var xDate = parseInt(earliestDate + ((latestDate - earliestDate) * xPerc));
            var closestDate = closestNumberInArray(xDate, eventDates);
            var datePerc = eventDates.indexOf(closestDate) / eventDates.length;
            var $event = $('[data-dateid="' + closestDate + '"]').eq(0);
            elm.find('.timeline-label').html(($event.attr('data-date') || "").replace(/, /,', <strong>') + "</strong>").attr('data-id',$event.attr('data-id')).attr('data-perc', datePerc).css('left', (100 * (0.05 + (xPerc * 0.9))) + "%");
        } else {
            elm.find('.timeline-label').empty();
        }
    }

    function displayTimelineMinAndMax(){
        var $events = $('.events .event');
        var firstDate = moment(chron.parseDate($events.eq($events.length - 1).find('.author').text())).format('MMM D, [<strong>]YYYY[</strong>]');
        var lastDate = moment(chron.parseDate($events.eq(0).find('.author').text())).format('MMM D, [<strong>]YYYY[</strong>]');
        firstDate = firstDate.toLowerCase() != "invalid date" ? firstDate : "";
        lastDate = lastDate.toLowerCase() != "invalid date" ? lastDate : "";
        $('.navigation-timeline .first-date').html(firstDate);
        $('.navigation-timeline .last-date').html(lastDate);
    }

    function highlightEventForXSeconds(id, s){
        $('.events .event').css('background-color','').reflow();
        var $event = $('.events .event[data-id="'+id+'"]').eq(0);
        $event.css('background-color','#f4f1ff');
        setTimeout(function(){
            $event.css('background-color','').reflow();
        }, (s * 1000));
    }

    function closestNumberInArray(num, arr){
        var curr = arr[0];
        var diff = Math.abs (num - curr);
        for (var val = 0; val < arr.length; val++) {
            var newdiff = Math.abs (num - arr[val]);
            if (newdiff < diff) {
                diff = newdiff;
                curr = arr[val];
            }
        }
        return curr;
    }

    function updateDatePrediction(){
        if (!manualDateSet || !$('.event-new-date').text().replace(/\s+/,'').length){
            var datePrediction = getTimeTextFromString(parseDateTimestamp($('.event-new-content').text()), true);
            if (datePrediction) $('.event-new-date').text(datePrediction);
        }
    }

    function copyElementTextToClipboard(element){
        try {
            var $element = $(element);
            var DOMelement = $(element).get(0);
            if (document.selection) {
                var range = document.body.createTextRange();
                range.moveToElementText(DOMelement);
                range.select();
            } else if (window.getSelection) {
                var range = document.createRange();
                range.selectNode(DOMelement);
                window.getSelection().addRange(range);
            }
            var didCopy = document.execCommand('copy');
            if (didCopy){
                $element.addClass('alert-copied');
                setTimeout(function(){
                    $element.removeClass('alert-copied');
                }, 2000);
            }
        } catch(e){
            console.warn("Error copying to clipboard:");
            console.warn(e);
        }
    }

    function updatePublishButtonState(){
        if ($('.event-new-title').text().length > 0 && parseDateTimestamp($('.event-new-date').text())){
            $('.event-new-publish').removeClass('disabled');
        } else {
            $('.event-new-publish').addClass('disabled');
        }
    }

    function onTimelineChanged(snapshot){
        timelineData = snapshot.val();
        timelineData.id = snapshot.key;
        var name = timelineData.name;
        if (name == null || name == undefined || name == "") name = "Timeline";
        $('.navigation-block .navigation-title').text(name);
        updateUserTimelineTimestamp(timelineData.id);
        updateTimelineSharing();
    }

    function onEventsChanged(snapshot){
        displayTimelineFromSnapshot(snapshot);
    }

    function onConnectionChanged(snapshot) {
        var isNotConnected = snapshot.val() === true;
        setNoConnectionBarVisible(isNotConnected);
    }

    function warnError(error){
        console.warn(error);
    }

    function getInitialData(){
        timelineRef.on('value', onTimelineChanged, warnError);
        eventsRef.orderByChild('date').on('value', onEventsChanged, warnError);
    }

    function displayTimelineFromSnapshot(snapshot){
        var items = [];
        snapshot.forEach(function(child) {
            var item = child.val();
            item.id = child.key;
            items.push(item);
        });
        displayTimelineFromEventList(items);
    }

    function displayTimelineFromEventList(itemList){
        $('.timeline-container .events').html('');
        var childEventId = null;
        eventDates = [];
        itemList.forEach(function(item){
            var eventDateId = parseInt(item.date.replace(/ [0-2][0-9]:[0-5][0-9]/,'').split('/').join(''));
            if (getUrlHash() == getPublicReferenceFromId('e', item.id) && item.isPublished) childEventId = item.id;
            item.eventDateId = eventDateId;
            $('.timeline-container .events').prepend(getEventElementFromEvent(item));
            if (item.date) eventDates.push(eventDateId);
        })
        displayTimelineMinAndMax();
        if (childEventId != null) getEventByID(childEventId,openNewEvent);
    }

    function getPublicReferenceFromId(r, id){
        return r + reverseString(id.toString());
    }

    function getIdFromPublicReference(ref){
        return reverseString(ref.substring(1,ref.length));
    }

    function getZeroPaddedNumber(num, size) {
        var s = num+"";
        while (s.length < size) s = "0" + s;
        return s;
    }

    function truncateStringToXWords(string,x){
        var parts = removeFromArrayByValue(string.split(' ').map(function(s,i){ return (s.length && i < x+1) ? s : ''}),'');
        return parts.join(' ') + (parts.length >= 75 ? '...' : '');
    }

    function getEventElementFromEvent(event, isPreview){
        if (event.isPublished) {
            var isPreview = isPreview && isPreview != null && isPreview === true ? true : false;
            var $event = $('<div class="event scrollbar-custom"></div>').attr('data-id', event.id);
            var $title = $('<h1>'+event.title+'</h1>');
            $event.append($('<div class="title">').append($title));
            $event.attr('data-dateid', event.eventDateId);
            $event.attr('data-date', moment(chron.parseDate(event.date.replace(/ [0-2][0-9]:[0-5][0-9]/,''))).format('MMM D, YYYY'));
            if (event.content){
                var $content = isPreview ? $(marked(truncateStringToXWords(event.content || "",75))) : $(marked(event.content || ""));
                $content.find('a').attr('target','_blank');
                $event.append($('<div class="content">').append($content));
            }
            var $author = getMetaElement(event.author, event.date);
            if (!event.isPublished) {
                $event.addClass('unpublished');
            }
            $event.append($author);

            if (!$('body.user-anonymous').length && firebase.auth().currentUser && event.author.uid === firebase.auth().currentUser.uid) {
                $event.append($('<div class="event-delete button button-light color-destructive">Delete</div>').attr('onclick','deleteEvent('+event.createdOn+')'));
            }

            return $event;
        }
    }

    function getMetaElement(author, date, inNewEvent){
        if (inNewEvent) {
            var $author = $('<div class="author no-underline"></div>');
            var $signOutLink = $('<div>').addClass('button-light').attr('onClick','signOut()');
            $author.append($signOutLink).addClass('name sans-serif');
        } else {
            var $author = $('<div class="author no-underline"></div>');
            var timeText = getTimeTextFromString(date) ? 'Date: ' + getTimeTextFromString(date) : "";
            $author.append($(marked(timeText)).addClass('name sans-serif'));
        }
        return $author;
    }

    function getCurrentAuthor(){
        var user = firebase.auth().currentUser;
        return {
            image : user.photoURL,
            link : "https://twitter.com/intent/user?user_id=" + user.providerData[0].uid,
            name : user.displayName,
            uid : user.uid,
        }
    }

    function addCurrentAuthorToNewEvent(){
        $('.timeline-container .event-new .author').remove();
        var $author = getMetaElement(getCurrentAuthor(), null, true);
        $('.timeline-container .event-new-publish-container').prepend($author);
    }

    function createOrUpdateEvent(){
        var unix = firebase.database.ServerValue.TIMESTAMP;
        var isUpdate = $('.event-new').attr('data-id') != undefined;
        var createdOn = isUpdate ? parseInt($('.event-new').attr('data-id')) : unix;
        var parsedDate = parseDateTimestamp(document.querySelectorAll('.event-new .event-new-date')[0].innerText);
        parsedDate = parsedDate ? parsedDate : parseDateTimestamp(createdOnOrNow);
        var event = {
            'author' : getCurrentAuthor(),
            'content' : document.querySelectorAll('.event-new .event-new-content')[0].innerText,
            'createdOn' : createdOn,
            'isPublished' : true,
            'title' : document.querySelectorAll('.event-new .event-new-title')[0].innerText,
            'updatedOn': unix,
            'date': parsedDate
        };
        if (isUpdate){
            writeData(eventsRef, createdOn, event, function(){ closeNewEvent(true) });
            updateUserTimelineTimestamp(timelineRef.key);
        } else {
            pushData(eventsRef, '/', event, function(){ closeNewEvent(true) })
        }
    }

    function openNewEvent(event){
        closeChildPage();
        if (event != null && typeof event === 'object' && event.createdOn){
            window.location.hash = getPublicReferenceFromId('e', event.id)
            $('.event-new-title').text(event.title);
            $('.event-new-content').text(event.content).focus();
            $('.event-new-date').text(getTimeTextFromString(event.date, true));
            $('.event-new').attr('data-id', event.createdOn);
            manualDateSet = true;
        } else {
            $('.event-new-title').text('').focus();
            $('.event-new-content').text('')
            $('.event-new-date').text('');
            manualDateSet = false;
        }
        $('.event-new').addClass('visible');
        $('.timeline-container').addClass('child-page');
        updatePublishButtonState();
        $('html, body').animate({
            scrollTop : 0,
        }, 200);
    }

    function deleteEvent(id){
        closeChildPage();
        writeData(eventsRef, id, null);
        updateUserTimelineTimestamp(timelineRef.key);
    }

    function publishEvent(id){
        writeData(eventsRef, id+'/isPublished', true);
        updateUserTimelineTimestamp(timelineRef.key);
    }

    function unpublishEvent(id){
        writeData(eventsRef, id+'/isPublished', false);
        updateUserTimelineTimestamp(timelineRef.key);
    }

    function getEventByID(id, callback){
        eventsRef.child(id).once('value', function(snapshot) {
            var event = snapshot.val();
            event.id = snapshot.key;
            callback(event);
        }, function(error){
            console.warn('Get event by ID error:')
            console.warn(error);
        });
    }

    function openChildPage(id){
        isChildPage = true;
        getEventByID(id,loadChildPage);
        $('.timeline-container').addClass('child-page');
        $('.event-child').addClass('visible');
        setTimeout(function(){
            $('html,body').scrollTop(0);
        },0)
    }

    function loadChildPage(event){
        window.location.hash = getPublicReferenceFromId('e', event.createdOn)
        $('.event-child .event-content').empty().append(getEventElementFromEvent(event));
        $('.event-child .gmph-button.twitter').attr('href','https://twitter.com/home?status='+encodeURIComponent(event.title)+'%20'+encodeURIComponent(window.location.href)+'%20by%20%40gmph');
        $('.event-child .gmph-button.facebook').attr('href','https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(window.location.href));
    }

    function closeChildPage(){
        isChildPage = false;
        window.location.hash = "";
        $('.timeline-container').removeClass('child-page');
        $('.event-child').removeClass('visible');
    }

    function openTimelines(){
        displayTimelineList();
        $('.timeline-container').addClass('child-page');
        $('.timelines.popup').addClass('visible');
    }

    function closeTimelines(){
        if ($('.timelines.popup').hasClass('visible')){
            $('.timelines.popup').removeClass('visible');
            $('.timeline-container').removeClass('child-page');
            return true;
        } else {
            return false;
        }
    }

    function addTimelinesDataToUserData(){
        var timelineIds = Object.keys(userData.timelines);
        for (var i = 0; i < timelineIds.length; i++){
            rootRef.child('timelines/' + timelineIds[i]).once('value', function(snapshot){
                var timeline = snapshot.val();
                timeline.id = snapshot.key;
                userData.timelines[timeline.id] = timeline;
            }, function(error){
                console.warn(error);
            });
        }
    }

    function displayTimelineList(callback){
        var $timelineList = $('.timelines .timeline-list');
        $timelineList.empty();
        var timelineIds = Object.keys(userData.timelines);
        for (var i = 0; i < timelineIds.length; i++){
            $('.timelines.popup .timeline-list').append(getTimelineListItemElementFromTimeline(userData.timelines[timelineIds[i]]));
        }
    }

    function updateUserTimelineTimestamp(id){
        if (isPushKey(id)) writeData(userRef, 'timelines/' + id, firebase.database.ServerValue.TIMESTAMP);
    }

    function getTimelineListItemElementFromTimeline(timeline){
        if (timeline.isArchived == undefined || timeline.isArchived !== true){
            var name = timeline.name;
            if (name == null || name == undefined || name == "") name = "Timeline";
            var date = getTimeTextFromUnix(timeline.createdOn)
            var $timeline = $('<div>')
                .addClass('timeline')
                .attr('data-id', timeline.id);
            var $title = $('<div>')
                .addClass('title')
                .text(name);
            var $deleteButton = $('<div>')
                .addClass('timeline-delete button-light color-destructive')
                .text('Delete');
            $timeline.append($title, $deleteButton);
            return $timeline;
        } else {
            return null;
        }
    }

    function openNewTimeline(){
        $('.timeline-container').addClass('child-page');
        $('.timeline-new.popup').addClass('visible');
        $('.timeline-new .timeline-new-name').focus();
    }

    function closeNewTimeline(didCreateTimeline){
        if ($('.timeline-new.popup').hasClass('visible')){
            $('.timeline-container').removeClass('child-page');
            $('.timeline-new.popup').removeClass('visible');
            $('.timeline-new .timeline-new-name').text('');
            if (didCreateTimeline !== true) openTimelines();
            blurAllFields();
            return true;
        } else {
            return false;
        }

    }

    function openShareTimeline(){
        $('.timeline-container').addClass('child-page');
        $('.timeline-share.popup').addClass('visible');
    }

    function closeShareTimeline(){
        if ($('.timeline-share.popup').hasClass('visible')){
            $('.timeline-container').removeClass('child-page');
            $('.timeline-share.popup').removeClass('visible');
            return true;
        } else {
            return false;
        }

    }

    function toggleTimelineSharing(){
        writeData(timelineRef, 'isPublic', !timelineData.isPublic);
        updateUserTimelineTimestamp(timelineRef.key);
    }

    function updateTimelineSharing(){
        var isSharedTimeline = timelineData.isPublic;
        if (isSharedTimeline){
            $('.timeline-share .timeline-share-url')
                .addClass('visible')
                .text(getTimelineSharingUrlFromId(timelineData.id));
            $(".timeline-share #timeline-share-checkbox").prop("checked", true);
        } else {
            $('.timeline-share .timeline-share-url')
                .removeClass('visible')
                .text('Enable sharing to get your link');
            $(".timeline-share #timeline-share-checkbox").prop("checked", false);
        }
    }

    function getTimelineSharingUrlFromId(id){
        return getCurrentRootUrl() + "#" + getPublicReferenceFromId('t',id);
    }

    function getCurrentRootUrl(){
        return window.location.protocol + "//" + window.location.hostname + (window.location.port ? ":" + window.location.port : "") +  window.location.pathname;
    }

    function openRootUrl(){
        window.onbeforeunload = null;
        window.location.href = getCurrentRootUrl();
    }

    function openURLInNewTab(url){
        var win = window.open(url, '_blank');
        win.focus();
    }

    function openImageSourceInNewTab(imageElement){
        var $image = $(imageElement);
        openURLInNewTab($image.attr('src'));
    }

    function blurAllFields(){
        $(':focus').blur();
    }

    function isTimelineId(hash){
        var hash = hash.replace('#','');
        return hash.charAt(0) === "t" && isPushKey(hash.substring(1, hash.length));
    }

    function isPushKey(key){
        return key.toString().length === 20 && /[^-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz]/g.test(key.toString()) === false;
    }

    function displayPublicTimeline(ref){
        $('.navigation-block').addClass('visible');
        $('body').addClass('user-anonymous');
        $('.sign-in.popup').removeClass('visible');
        window.onbeforeunload = function(e) {
            return 'Leave this website?';
        };
        rootRef.child('timelines/' + getIdFromPublicReference(ref)).on('value', function(snapshot){
            onTimelineChanged(snapshot);
            rootRef.child('events/' + getIdFromPublicReference(ref)).orderByChild('date').on('value', function(snapshot){
                displayTimelineFromSnapshot(snapshot);
                $('.events').scrollLeft(0);
            }, function(error){
                openRootUrl();
                warnError(error);
            });
        }, function(error){
            openRootUrl();
            warnError(error);
        });
    }

    function setSignInOrUserState(){
        if (isTimelineId(getUrlHash())){
            displayPublicTimeline(getUrlHash().replace('#',''));
        } else if (firebase.auth().currentUser) {
            addCurrentAuthorToNewEvent();
            $('.navigation-block').addClass('visible');
            $('.sign-in.popup').removeClass('visible');
            setUpChrono();
            attachEvents();
            updateUserData(function(){
                if (timelineRef === undefined) openTimeline();
            });
            blurAllFields();
            $('body').removeClass('user-anonymous');
            window.onbeforeunload = function(e) {
                return 'Leave this website?';
            };
        } else {
            $('.event-new, .navigation-block').removeClass('visible');
            $('.sign-in.popup').addClass('visible');
            $('.sign-in .sign-in-email').focus();
            $('.events').empty();
            $('.timelines.popup .timeline-list').empty();
            $('body').addClass('user-anonymous');
            window.onbeforeunload = null;
        }
    }

    function updateUserData(callback){
        var userId = firebase.auth().currentUser.uid;
        userRef = rootRef.child("/users/" + userId);
        userRef.on('value', function(snapshot){
            userData = snapshot.val();
            userData.id = snapshot.key;
            addTimelinesDataToUserData();
            if (callback) callback.call(this);
        }, function (error){
            userData = null;
            console.warn(error);
        });
    }

    function openTimeline(id){
        if (userData != null && userData != {} && userData.timelines && userData.timelines != null){
            var latestActiveTimelineId = Object.keys(userData.timelines)
                .filter(function(x){ return isTimelineId("t" + x) })
                .reduce(function(a, b){ return userData.timelines[a] > userData.timelines[b] ? a : b });
            var timelineId = userData.timelines[id] != undefined ? id : latestActiveTimelineId;
            timelineRef = rootRef.child("timelines/" + timelineId);
            eventsRef = rootRef.child("events/" + timelineId);
            getInitialData();
        } else if (id === undefined){
            createTimeline(false, openTimeline);
        } else {
            return false;
        }
    }

    function createTimeline(name, callback){
        if (firebase.auth().currentUser){
            var unix = firebase.database.ServerValue.TIMESTAMP;
            rootRef.child('timelines').push({
                "name" : name ? name : "Timeline",
                "owner" : firebase.auth().currentUser.uid,
                "isPublic" : false,
                "createdOn" : unix,
                "isArchived" : false,
            }).catch(function(error){
                console.warn(error);
            }).then(function(ref){
                var userId = firebase.auth().currentUser.uid;
                var key = ref.key;
                rootRef.child('users/' + userId + '/timelines/' + ref.key).set(unix).catch(function(error){
                    console.warn(error);
                }).then(function(ref){
                    closeNewTimeline(true);
                    if (callback) callback.call(this, key);
                });
            });
        } else {
            return false;
        }
    }

    function archiveTimeline(id, callback){
        if (firebase.auth().currentUser){
            writeData(rootRef, 'timelines/' + id + '/isArchived', true, function(){
                updateUserTimelineTimestamp(id);
                if (callback) callback.call(this, id);
            });
        } else {
            return false;
        }
    }

    function writeData(ref, key, value, callback){
        if (callback){
            ref.child(key).set(value, callback);
        } else {
            ref.child(key).set(value);
        }
    }

    function pushData(ref, path, value, callback){
        if (callback){
            ref.child(path).push(value, callback);
        } else {
            ref.child(path).push(value);
        }
    }

    function parseDateTimestamp(string){
        var parsedDate = chron.parse(string);
        return timestamp = parsedDate.length ? moment(parsedDate[0].start.date()).format('YYYY/MM/DD HH:mm') : false;
    }

    function signInOrCreateUserWithEmailAndPassword(email, password){
        firebase.auth().signInWithEmailAndPassword(email, password).catch(function(error) {
            if (error.code === "auth/user-not-found"){
                firebase.auth().createUserWithEmailAndPassword(email, password).then(function(result){
                    if (result.user){
                        deleteLocalData('timeline_user');
                        setLocalData('timeline_user', result.user);
                    }
                });
            }
        }).then(function(result){
            if (result.user){
                deleteLocalData('timeline_user');
                setLocalData('timeline_user', result.user);
            }
        });
    }

    function getUserFromLoginDetails(){

        firebase.auth().getRedirectResult().then(function(result) {
            if (result.user){
                user = result.user;
                deleteLocalData('timeline_user');
                setLocalData('timeline_user', user);
            } else {
                var provider = new firebase.auth.TwitterAuthProvider();
                firebase.auth().signInWithRedirect(provider);
            }
        }).catch(function(error) {
            var provider = new firebase.auth.TwitterAuthProvider();
            firebase.auth().signInWithRedirect(provider);
        });

    }

    function setLocalData(key, value){
        localStorage[key] = value;
    }

    function deleteLocalData(key){
        localStorage[key] = null;
    }

    function getLocalData(key){
        return localStorage[key];
    }

    function logInWithTwitter(){
        var provider = new firebase.auth.TwitterAuthProvider();
        firebase.auth().signInWithRedirect(provider);
    }

    function signOut(){
        firebase.auth().signOut().then(getInitialData);
    }

    function getTimeTextFromString(string, includeTime){
        try {
            var includeTime = includeTime === true;
            var format = includeTime ? 'MMM D, YYYY [at] HH:mm' : 'MMM D, YYYY'
            return moment(chron.parse(string)[0].start.date()).format(format);
        } catch (e){
            return false;
        }
    }

    function getTimeTextFromUnix(unix){
        var a = new Date(parseInt(unix));
        var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        var year = a.getFullYear();
        var month = months[a.getMonth()];
        var date = a.getDate();
        var hour = a.getHours();
        var min = a.getMinutes();
        var sec = a.getSeconds();
        var formatted = month + ' ' + date + ', ' + year;
        return formatted;
    }

    // Get #hash text value from current URL
    function getUrlHash(name, url) {
        return decodeURI((window.location.hash || "").replace(/#/g,''));
    }

    function reverseString(s){
        for (var i = s.length - 1, o = ''; i >= 0; o += s[i--]) { }
        return o;
    }

    function removeFromArrayByValue(arr) {
        var what, a = arguments, L = a.length, ax;
        while (L > 1 && arr.length) {
            what = a[--L];
            while ((ax= arr.indexOf(what)) !== -1) {
                arr.splice(ax, 1);
            }
        }
        return arr;
    }

    if (!Object.keys) {
        Object.keys = function (obj) {
            var keys = [],
            k;
            for (k in obj) {
                if (Object.prototype.hasOwnProperty.call(obj, k)) {
                    keys.push(k);
                }
            }
            return keys;
        };
    }

    $.fn.reflow = function () {
        this[0].offsetHeight;   // force redrawing of element
        return this;
    };

    $.fn.cssStatic = function (name, value) {
        return this
        .css('transition', 'none')
        .css(name, value)
        .reflow()
        .css('transition', '');
    };

</script>

</body>

</html>
